# This file is auto-generated by MACH Framework
# Site: {{ site.identifier }}

terraform {
  {% if general_config.terraform_config.azure_remote_state %}
  {% set azure_config = general_config.terraform_config.azure_remote_state %}
  backend "azurerm" {
    resource_group_name  = "{{ azure_config.resource_group_name }}"
    storage_account_name = "{{ azure_config.storage_account_name }}"
    container_name       = "{{ azure_config.container_name }}"
    key                  = "{{ azure_config.state_folder}}/{{ site.identifier }}"
  }
  {% endif %}
}

provider "azurerm" {
  version = "=2.19.0"
  {% if site.azure %}
  subscription_id = "{{ site.azure.subscription_id }}"
  tenant_id       = "{{ site.azure.tenant_id }}"
  skip_provider_registration = true
  {% endif %}
  features {}
}

{% set commercetools = site.commercetools %}
provider "commercetools" {
  version       = "=0.22.1"
  client_id     = "{{ commercetools.client_id }}"
  client_secret = "{{ commercetools.client_secret }}"
  project_key   = "{{ commercetools.project_key }}"
  scopes        = "{{ commercetools.scopes }}"
  token_url     = "{{ commercetools.token_url }}"
  api_url       = "{{ commercetools.api_url }}"
}

{% if site.commercetools %}
{% set commercetools = site.commercetools %}
resource "commercetools_project_settings" "project" {
  name       = "{{ commercetools.project_key }}"
  countries  = [{% for country in commercetools.countries %}"{{ country }}"{% if not loop.last %},{% endif %}{% endfor %}]
  currencies = [{% for currency in commercetools.currencies %}"{{ currency }}"{% if not loop.last %},{% endif %}{% endfor %}]
  languages  = [{% for language in commercetools.languages %}"{{ language }}"{% if not loop.last %},{% endif %}{% endfor %}]
  messages   = {
    enabled = {{ site.commercetools.messages_enabled | string | lower }}
  }
}

{% if site.commercetools.channels %}
{% for channel in site.commercetools.channels %}
resource "commercetools_channel" "{{ channel.key }}" {
  key = "{{ channel.key }}"
  roles = [{% for role in channel.roles %}"{{ role }}"{% if not loop.last %}, {% endif %}{% endfor %}]

  {% if channel.name %}
  name = {
    {% for language, localized_name in channel.name.items() %}
    {{ language }} = "{{ localized_name }}"
    {% endfor %}
  }
  {% endif %}

  {% if channel.description %}
  description = {
    {% for language, localized_name in channel.description.items() %}
    {{ language }} = "{{ localized_name}}"
    {% endfor %}
  }
  {% endif %}
}
{% endfor %}

output "frontend_channels" {
    value = [
        {% for channel in site.commercetools.channels %}commercetools_channel.{{ channel.key }}.id,{% endfor %}
    ]
}

{% endif %}

{% if site.commercetools.taxes %}
resource "commercetools_tax_category" "standard" {
  name = "Standard tax category"
  key  = "standard"
}

{% for tax in site.commercetools.taxes %}
resource "commercetools_tax_category_rate" "{{ tax.country|lower }}_vat" {
  tax_category_id = commercetools_tax_category.standard.id
  name = "{{ tax.name }}"
  amount = {{ tax.amount }}
  country = "{{ tax.country }}"
  included_in_price = true
}
{% endfor %}
{% endif %}
{% endif %}

{% if site.stores %}
{% set stores = site.stores %}
    {% for store in stores %}
resource "commercetools_store" "{{ store.key }}" {
  key  = "{{ store.key }}"
  name = {
    {% for language, localized_name in store.name.items() %}
        {{ language  }} = "{{ localized_name }}"
    {% endfor %}
  }
  {% if store.languages %}
  languages  = [{% for language in store.languages %}"{{ language }}"{% if not loop.last %},{% endif %}{% endfor %}]
  {% endif %}
   {% if store.distribution_channels %}
  distribution_channels = [{% for dc in store.distribution_channels %}"{{ dc }}"{% if not loop.last %},{% endif %}{% endfor %}]

  depends_on = [{% for dc in store.distribution_channels %}commercetools_channel.{{ dc }}{% if not loop.last %},{% endif %}{% endfor %}]
  {% endif %}
}

    {% if site.create_frontend_credentials %}
resource "commercetools_api_client" "frontend_credentials_{{ store.key }}" {
  name = "frontend_credentials_terraform_{{ store.key }}"
  scope = [
    "manage_my_profile:{{ site.commercetools.project_key }}",
    "manage_my_orders:{{ site.commercetools.project_key }}",
    "manage_my_orders:{{ site.commercetools.project_key}}:{{ store.key }}",
    "view_states:{{ site.commercetools.project_key }}",
    "manage_my_shopping_lists:{{ site.commercetools.project_key }}",
    "view_products:{{ site.commercetools.project_key }}",
    "manage_my_payments:{{ site.commercetools.project_key}}",
    "create_anonymous_token:{{ site.commercetools.project_key }}",
    "view_project_settings:{{ site.commercetools.project_key }}"
  ]

  depends_on = [commercetools_store.{{ store.key }}]
}

output "frontend_client_scope_{{ store.key }}" {
  value = commercetools_api_client.frontend_credentials_{{ store.key }}.scope
}

output "frontend_client_id_{{ store.key }}" {
  value = commercetools_api_client.frontend_credentials_{{ store.key }}.id
}

output "frontend_client_secret_{{ store.key }}" {
  value = commercetools_api_client.frontend_credentials_{{ store.key }}.secret
}
    {% endif %}
{% endfor %}
{% elif site.create_frontend_credentials %}

resource "commercetools_api_client" "frontend_credentials" {
  name = "frontend_credentials_terraform"
  scope = [
    "manage_my_profile:{{ site.commercetools.project_key }}",
    "manage_my_orders:{{ site.commercetools.project_key }}",
    "manage_my_orders:{{ site.commercetools.project_key}}",
    "view_states:{{ site.commercetools.project_key }}",
    "manage_my_shopping_lists:{{ site.commercetools.project_key }}",
    "view_products:{{ site.commercetools.project_key }}",
    "manage_my_payments:{{ site.commercetools.project_key}}",
    "create_anonymous_token:{{ site.commercetools.project_key }}",
    "view_project_settings:{{ site.commercetools.project_key }}"
  ]
}

output "frontend_client_scope" {
    value = commercetools_api_client.frontend_credentials.scope
}

output "frontend_client_id" {
    value = commercetools_api_client.frontend_credentials.id
}

output "frontend_client_secret" {
    value = commercetools_api_client.frontend_credentials.secret
}
{% endif %}

{% if site.azure %}
locals {
  region_display_map_long = {
    "westeurope"  = "West Europe"
    "northeurope" = "North Europe"
  }

  region_display_map_short = {
    "westeurope"  = "we"
    "northeurope" = "ne"
  }

  region_full  = local.region_display_map_long["{{ site.azure.region }}"]
  region_short = local.region_display_map_short["{{ site.azure.region }}"]

  name_prefix             = format("{{ general_config.azure.resources_prefix|default:"" }}{{ site.identifier| replace("dev", "d") | replace("tst", "t") | replace("prd", "p") }}-%s", local.region_short)
  tenant_id               = "{{ site.azure.tenant_id }}"
  service_object_ids      = {
      {% for key, value in site.azure.service_object_ids.items() %}
          {{ key }} = "{{ value }}"
      {% endfor %}
  }
  region                  = "{{ site.azure.region }}"
  subscription_id         = "{{ site.azure.subscription_id }}"
  project_key             = "{{ site.commercetools.project_key }}"

  /* Could put more tags here */
  tags = {
    project_key = "{{ site.commercetools.project_key }}"
  }
}

resource "azurerm_resource_group" "main" {
  name     = format("%s-rg", local.name_prefix)
  location = local.region_full

  tags = local.tags
}



{% if site.azure.alert_group %}
{% if site.azure.alert_group.logic_app %}
data "azurerm_logic_app_workflow" "alert_logic_app" {
  name                = "{{ site.azure.alert_group.logic_app_name }}"
  resource_group_name = "{{ site.azure.alert_group.logic_app_resource_group }}"
}
{% endif %}

resource "azurerm_monitor_action_group" "alert_action_group" {
  name                = "{{ site.identifier }}-{{ site.azure.alert_group.name }}"
  resource_group_name = azurerm_resource_group.main.name
  short_name          = "{{ site.azure.alert_group.name|replace(" ", "")|replace("-", "")|lower }}"

  {% for email in site.azure.alert_group.alert_emails %}
  email_receiver {
    name          = "{{ email }}"
    email_address = "{{ email }}"
  }
  {% endfor %}

  {% if site.azure.alert_group.logic_app %}
  logic_app_receiver {
      name                    = "Logic app receiver"
      resource_id             = data.azurerm_logic_app_workflow.alert_logic_app.id
      callback_url            = data.azurerm_logic_app_workflow.alert_logic_app.access_endpoint
      use_common_alert_schema = true
  }
  {% endif %}

  {% if site.azure.alert_group.webhook_url %}
  webhook_receiver {
    name                    = "alert_webhook"
    service_uri             = "{{ site.azure.alert_group.webhook_url }}"
    use_common_alert_schema = true
  }
  {% endif %}
}
{% endif %}

{% if site.components %}
resource "azurerm_app_service_plan" "functionapps" {
  name                = format("%s-plan", local.name_prefix)
  resource_group_name = azurerm_resource_group.main.name
  location            = azurerm_resource_group.main.location
  kind                = "FunctionApp"
  reserved            = true

  sku {
    tier = "Dynamic"
    size = "Y1"
  }

  tags = local.tags
}
{% endif %}

locals {
    front_door_domain = format("%s-fd.azurefd.net", local.name_prefix)
}

locals {
    front_door_domain_identifier = replace(local.front_door_domain, ".", "-")
}

{% if site.azure.front_door  %}
data "azurerm_dns_zone" "domain" {
    name                = "{{ site.azure.front_door.dns_zone }}"
    resource_group_name = "{{ site.azure.front_door.resource_group_name }}"
}

data "azurerm_key_vault" "ssl" {
  name                = "{{ site.azure.front_door.ssl_key_vault_name }}"
  resource_group_name = "{{ site.azure.front_door.resource_group_name }}"
}

locals {
    front_door_external_domain = "{{ site.commercetools.project_key }}.{{ site.azure.front_door.dns_zone }}"
}

locals {
    front_door_external_domain_identifier = replace(local.front_door_external_domain, ".", "-")
}

resource "azurerm_dns_cname_record" "{{ site.commercetools.project_key }}" {
  name                = "{{ site.commercetools.project_key }}"
  zone_name           = data.azurerm_dns_zone.domain.name
  resource_group_name = "{{ site.azure.front_door.resource_group_name }}"
  ttl                 = 600
  record              = local.front_door_domain
}
{% endif %}

### Frontdoor
{% if site.public_api_components %}
resource "azurerm_frontdoor" "app-service" {
  name                                          = format("%s-fd", local.name_prefix)
  resource_group_name                           = azurerm_resource_group.main.name
  enforce_backend_pools_certificate_name_check  = false
  tags = local.tags

  backend_pool_load_balancing {
    name = "lbSettings"
  }

  frontend_endpoint {
    name                              = local.front_door_domain_identifier
    host_name                         = local.front_door_domain
    custom_https_provisioning_enabled = false
  }

  {% if site.azure.front_door  %}
  frontend_endpoint {
    name                              = local.front_door_external_domain_identifier
    host_name                         = local.front_door_external_domain
    custom_https_provisioning_enabled = true

    custom_https_configuration {
      certificate_source                         = "AzureKeyVault"
      azure_key_vault_certificate_vault_id       = data.azurerm_key_vault.ssl.id
      # no data source for certificates yet.
      azure_key_vault_certificate_secret_name    = "{{ site.azure.front_door.ssl_key_vault_secret_name }}"
      azure_key_vault_certificate_secret_version = "{{ site.azure.front_door.ssl_key_vault_secret_version }}"
    }
  }
  {% endif %}

  {% for component in site.public_api_components %}
  backend_pool_health_probe {
    name = "{{ component.name }}-hpSettings"
    path = "{% if component.health_check_path %}{{ component.health_check_path }}{% else %}/{{ component.name }}/healthchecks{% endif %}"
    protocol = "Https"
    enabled = false
    probe_method = "HEAD"
  }

  routing_rule {
    name               = "http-https-redirect"
    accepted_protocols = ["Http"]
    patterns_to_match  = ["/*"]
    frontend_endpoints = [local.front_door_domain_identifier, local.front_door_external_domain_identifier]
    redirect_configuration {
      redirect_type     = "PermanentRedirect"
      redirect_protocol = "HttpsOnly"
    }
  }

  routing_rule {
    name               = "{{ component.name }}-routing-rule"
    accepted_protocols = ["Https"]
    patterns_to_match  = ["/{{ component.name }}/*"]
    frontend_endpoints = [local.front_door_domain_identifier{% if site.azure.front_door %}, local.front_door_external_domain_identifier{% endif %}]
    forwarding_configuration {
        forwarding_protocol = "MatchRequest"
        backend_pool_name   = "{{ component.name }}"
    }
  }

  backend_pool {
    name = "{{ component.name }}"
    backend {
        host_header = "${local.name_prefix}-func-{{ component.short_name }}.azurewebsites.net"
        address     = "${local.name_prefix}-func-{{ component.short_name }}.azurewebsites.net"
        http_port   = 80
        https_port  = 443
    }

    load_balancing_name = "lbSettings"
    health_probe_name   = "{{ component.name }}-hpSettings"
  }
  {% endfor %}

  depends_on = [azurerm_dns_cname_record.{{ site.commercetools.project_key }}]
}
{% endif %}
{% endif %}

{% if site.components %}
{% set components = site.components %}
{% for component in components %}
module "{{ component.name }}" {
  source            = "{{ component.source }}?ref={{ component.version }}"
  {% if component.is_software_component %}
  # keep the same order as the module's variables!

  ### azure related
  short_name              = "{{ component.short_name }}"
  name_prefix             = local.name_prefix
  subscription_id         = local.subscription_id
  tenant_id               = local.tenant_id
  service_object_ids      = local.service_object_ids
  region                  = local.region
  resource_group_name     = azurerm_resource_group.main.name
  resource_group_location = azurerm_resource_group.main.location
  app_service_plan_id     = azurerm_app_service_plan.functionapps.id
  tags                    = local.tags

  ### functionality related
  component_version       = "{{ component.version }}"
  environment             = "{{ general_config.environment }}"
  site                    = "{{ site.identifier }}"
  {% if general_config.sentry %}
  sentry_dsn              = "{{ general_config.sentry.dsn }}"
  {% endif %}
  {% if site.azure.alert_group %}
  monitor_action_group_id = azurerm_monitor_action_group.alert_action_group.id
  {% endif %}
  {% if site.base_url %}
  base_url                = "{{ site.base_url }}"
  {% endif %}
  {% if site.stores %}
  stores                  = [{% for store in site.stores %}"{{ store.key }}"{% if not loop.last %},{% endif %}{% endfor %}]
  {% endif %}

  # todo make simple jinja filter
  variables = {
    CT_API_URL = "{{ site.commercetools.api_url }}"
    # TODO: make token url / auth url consistent
    CT_AUTH_URL = "{{ site.commercetools.token_url }}"
    CT_PROJECT_KEY = "{{ site.commercetools.project_key }}"
    {% if component.has_public_api %}
    FRONTDOOR_ID = azurerm_frontdoor.app-service.header_frontdoor_id
    {% endif %}
  {% for key, value in component.variables.items() %}
      {{ key }} = {{ value|component_value }}
  {% endfor %}
  }

  secrets = {
  {% for key, value in component.secrets.items() %}
      {{ key }} = {{ value|component_value }}
  {% endfor %}

  {% if site.stores %}
      {% for store_name, store_secret_variables in component.store_secrets.items() %}
          {% for sv_name, sv_value in store_secret_variables.items() %}
              {{ store_name| upper }}_{{ sv_name }} = {{ sv_value|component_value }}
          {% endfor %}
      {% endfor %}
  {% endif %}
  }

  environment_variables = {
    {% filter indent(width=4) %}
    {% for key, value in component.variables.items() %}
      {{ key }} = {{ value|component_value }}
    {% endfor %}

    {% if site.stores %}
        STORES = "{% for store in site.stores %}{{ store.key }}{% if not loop.last %},{% endif %}{% endfor %}"
        {% if site.stores|length == 1 %}
            DEFAULT_STORE = "{{ site.stores[0].key }}"
            STORE         = "{{ site.stores[0].key }}"
        {% endif %}

        {% for store_name, store_variables in component.store_variables.items() %}
           {% for sv_name, sv_value in store_variables.items() %}
               {{ store_name| upper }}_{{ sv_name }} = {{ sv_value|component_value }}
           {% endfor %}
        {% endfor %}
    {% endif %}
    {% endfilter %}
  }
  {% endif %}
}

{% if component.is_software_component %}
# see https://docs.microsoft.com/en-us/azure/azure-functions/functions-deployment-technologies#trigger-syncing
# this updates the functionapp in case of any changes.
data "external" "sync_triggers_{{ component.name }}" {
  program = ["bash", "-c", "az rest --method post --uri 'https://management.azure.com/subscriptions/${local.subscription_id}/resourceGroups/${azurerm_resource_group.main.name}/providers/Microsoft.Web/sites/${module.{{ component.name }}.app_service_name}/syncfunctiontriggers?api-version=2016-08-01'"]

  # need to make sure this runs after the module
  depends_on = [
    module.{{ component.name }}.app_service_name
  ]
}
{% endif %}

{% endfor %}
{% endif %}
